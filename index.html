<!DOCTYPE html> 
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="manifest" href="manifest.json">
<link rel="icon" href="icon.jpg" type="image/jpeg">
<meta name="theme-color" content="#0b5ed7">
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/service-worker.js');
  }
</script>

<title>Choir Attendance</title>
<style>
  body { font-family: 'Segoe UI', sans-serif; background: #f7fafc; padding: 10px; }
  h1 { text-align: center; color: #0b5ed7; }
  table {
    width: 100%; border-collapse: collapse; background: #fff;
    margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    border-radius: 6px; overflow: hidden;
  }
  th, td { border: 1px solid #e2e8f0; padding: 6px 8px; text-align: center; }
  th { background: #e9ecef; }
  td:first-child { text-align: left; }
  button {
    background: #0b5ed7; color: white; border: none;
    border-radius: 6px; padding: 10px 15px; margin: 5px;
  }
  button:hover { background: #084298; }
  pre {
    background: #fff; padding: 10px; border-radius: 6px;
    white-space: pre-wrap; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }
</style>
</head>
<body>

<h1>Choir Attendance</h1>

<div style="text-align:center; margin-bottom:10px;">
  <strong>Date:</strong> <span id="todayDate"></span>
</div>

<div id="attendance-container"></div>

<div style="text-align:center;">
  <button onclick="generateReport()">Generate & Save Report</button>
  <button onclick="location.href='summary.html'">üìä View Summary</button>
  <button onclick="location.href='edit_members.html'">‚úèÔ∏è Edit Members</button>
</div>

<h2>Generated Report</h2>
<pre id="report"></pre>
<button id="copyBtn" style="display:none;" onclick="copyReport()">üìã Copy Report</button>

<script>
function loadChoirGroups() {
  const stored = localStorage.getItem("choirGroups");
  if (stored) return JSON.parse(stored);
  return {
    Tenor: ["Muange","Victor","Kennah","Paul","Agao","Karani","Derrick","N"],
    Alto: ["Eliza","Faith","Fiona","Hellen","Vero","Milah","Irine","Alivitsa","Mwende","Eva"],
    SOP: ["Gloria","Catherine","Monica","Kajuju","Mourine","Gabby","Liz","Mary","Neema","Lydia","Tess","Lavenda"],
    Bass: ["Pk","Bryson","Johnpaul","Ken","Sospeter","Victor","Robin","Franklin"]
  };
}

const today = new Date().toISOString().split("T")[0];
document.getElementById("todayDate").textContent = today;

const choirGroups = loadChoirGroups();
const container = document.getElementById("attendance-container");
let globalIndex = 1;

for (const [section, members] of Object.entries(choirGroups)) {
  const h2 = document.createElement("h2");
  h2.textContent = section;
  container.appendChild(h2);

  const table = document.createElement("table");
  table.innerHTML = `
    <thead><tr><th>Name</th><th>Present</th><th>Apology</th></tr></thead>
    <tbody></tbody>`;
  const tbody = table.querySelector("tbody");

  members.forEach(name => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${globalIndex}. ${name}</td>
      <td><input type="checkbox" id="present-${globalIndex}" onchange="toggleCheck(${globalIndex}, 'present')"></td>
      <td><input type="checkbox" id="apology-${globalIndex}" onchange="toggleCheck(${globalIndex}, 'apology')"></td>`;
    tbody.appendChild(row);
    globalIndex++;
  });

  container.appendChild(table);
}

function toggleCheck(i, type) {
  if (type === 'present')
    document.getElementById(`apology-${i}`).checked = false;
  else
    document.getElementById(`present-${i}`).checked = false;
}

function generateReport() {
  let report = `Choir Attendance (${today})\n`;
  let totalIndex = 1;
  let apologyList = [];
  let attendanceData = [];

  for (const [section, members] of Object.entries(choirGroups)) {
    report += `\n${section}\n`;
    let sectionCount = 1;

    members.forEach(name => {
      const present = document.getElementById(`present-${totalIndex}`).checked;
      const apology = document.getElementById(`apology-${totalIndex}`).checked;
      let status = "absent";
      if (present) status = "present";
      else if (apology) status = "apology";

      attendanceData.push({ section, name, status });

      if (status === "present") {
        report += `${sectionCount}. ${name}\n`;
        sectionCount++;
      } else if (status === "apology") {
        apologyList.push(name);
      }
      totalIndex++;
    });
  }

  report += `\nApologies\n`;
  apologyList.forEach((n, i) => report += `${i + 1}. ${n}\n`);

  document.getElementById("report").textContent = report;
  document.getElementById("copyBtn").style.display = "block";

  saveAttendance(today, attendanceData); // ‚úÖ Automatically save when generating
}

function copyReport() {
  const text = document.getElementById("report").textContent;
  const btn = document.getElementById("copyBtn");

  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text).then(() => {
      btn.textContent = "‚úÖ Copied!";
      setTimeout(() => btn.textContent = "üìã Copy Report", 2000);
    }).catch(err => {
      alert("Clipboard error: " + err);
    });
  } else {
    const textarea = document.createElement("textarea");
    textarea.value = text;
    document.body.appendChild(textarea);
    textarea.select();
    document.execCommand("copy");
    document.body.removeChild(textarea);

    btn.textContent = "‚úÖ Copied!";
    setTimeout(() => btn.textContent = "üìã Copy Report", 2000);
  }
}

async function saveAttendance(date, records) {
  const res = await fetch("https://script.google.com/macros/s/AKfycbzbOWDOUr4Vk5bvyL3VG_BCPr2slVOrLeivM1JlwY_tuUzBzD6JG_q4cODycuLrZ1MQ/exec", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(records)
  });
  const result = await res.json();
  console.log("Saved to Google Sheets:", result);
}
</script>
</body>
</html>
